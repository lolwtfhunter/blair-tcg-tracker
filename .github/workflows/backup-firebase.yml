name: Backup Firebase Data

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  backup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Fetch Firebase data
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%d_%H-%M-%S_UTC")
          DATE_FOLDER=$(date -u +"%Y-%m")

          mkdir -p backups/${DATE_FOLDER}

          curl -s "https://blair-pokemon-tracker-default-rtdb.firebaseio.com/collections/Blair2024.json" \
            -o backups/${DATE_FOLDER}/backup_${TIMESTAMP}.json

          cp backups/${DATE_FOLDER}/backup_${TIMESTAMP}.json backups/latest.json

          CONTENT=$(cat backups/${DATE_FOLDER}/backup_${TIMESTAMP}.json)
          if [ -z "$CONTENT" ] || [ "$CONTENT" = "null" ]; then
            echo "Backup is empty or null. Skipping commit."
            echo "SKIP_COMMIT=true" >> $GITHUB_ENV
          else
            echo "Backup created successfully."
            echo "SKIP_COMMIT=false" >> $GITHUB_ENV
          fi

      - name: Cleanup old backups
        if: env.SKIP_COMMIT == 'false'
        run: |
          find backups/ -name "*.json" -path "*/20*/*" -mtime +30 -delete 2>/dev/null || true
          find backups/ -type d -empty -delete 2>/dev/null || true

      - name: Commit backup
        if: env.SKIP_COMMIT == 'false'
        run: |
          git config user.name "Firebase Backup Bot"
          git config user.email "backup-bot@users.noreply.github.com"
          git add backups/
          git diff --cached --quiet && echo "No changes to commit" || (git commit -m "Auto-backup $(date -u +'%Y-%m-%d %H:%M UTC')" && git push origin main)
